# character_chat.py

## 개요  
OpenAI의 API를 이용하여 설정한 캐릭터와 일본어로 대화하는 채팅 스크립트입니다. 대화문을 CoT(Chain of Thought)로 생성, 즉 봇이 사용자의 발언 내용을 받아 생각하고 대답을 하는 방식입니다.

CoT를 채택함으로써 캐릭터의 일관성을 유지하는 것을 목표로 했다. 좀 더 구체적으로 말하면, ChatGPT의 '어시스턴트 AI'로서의 성격을 감추는 것이 목적이다.

또한, 캐릭터 설정, 샘플 대화, 최근 대화 외에도 이전 대화 내용을 요약하여 맥락에 포함시킨다. 이는 ChatGPT처럼 AI가 생성한 대사가 문맥에 축적되어 캐릭터 붕괴가 진행되는 문제를 해결하기 위함이다. (현재 버전에서는 과거의 기억을 활용하지 못하고 있지만, 장기 기억으로 수시로 불러올 수 있는 구조를 구상 중입니다).

캐릭터 설정, 대화 요약, 대화 내용은 캐릭터(대화) 별로 JSON 파일로 저장할 수 있다. 대화 내용은 파일에 추가되어 대화 중단, 재개가 가능합니다.

이 스크립트는 자신의 API 키를 사용하여 직접 사용하는 것을 전제로 하고 있습니다. 자신의 책임 하에 사용하시기 바랍니다.

## 사전 준비
OpenAI 모듈을 설치합니다.

pip install openai
환경 변수 OPENAI_API_KEY에 자신의 API 키를 입력합니다. Windows 환경이라면 아래와 같은 배치 파일을 만들면 편리할 것이다.

@echo off
set OPENAI_API_KEY=당신의 API_KEY
python character_chat.py conversations_sample_01.json
대화 파일(JSON 형식)에 아래와 같은 형식으로 캐릭터 설정을 작성합니다. 이 파일에는 대화 로그도 추가됩니다. 몇 가지 샘플을 준비하였으니 참고하시기 바랍니다.

## 실행 방법

## 구문
python character_chat.py [-h] [--model model] [--rapid-mode-threshold length] [--send-url url] [--no-show-action] [--no-show-error] json_path
파라미터
필수 파라미터: 필수

## json_path
대화 JSON 파일 경로. 파일은 스크립트 파일과 동일한 디렉토리에 배치하거나 전체 경로를 지정한다.
옵션 파라미터: -h, --help

-h, --help
도움말 메시지를 표시하고 종료한다.
--model model, -m model
사용할 OpenAI 모델, gpt-3.5-turbo 또는 gpt-4 지정 가능 (기본값: gpt-3.5-turbo)
--rapid-mode-threshold length
간편 모드를 활성화하는 최대 문자 수. 이 문자 수를 초과하면 일반 모드. (기본값: 6)
--send-url url
AI의 발언을 전송할 URL (예: http://localhost:8080/t={speech})
--no-show-action
AI의 행동 내용을 콘솔에 표시하지 않음
--no-show-error
AI가 대사를 생성하지 못한 경우에도 오류 메시지를 표시하지 않는다.
--model 옵션에는 gpt-3.5-turbo(기본값) 또는 gpt-4 중 하나를 지정한다. 이 스크립트는 1회 API 호출에 3000토큰 내외를 소모하므로, 사용료를 감안하여 모델 선택에 신중을 기해야 한다. 단, gpt-3.5-turbo에서는 충분한 대화 정확도를 얻지 못할 수 있습니다.

## 사용법
기본
콘솔에 무언가를 말하고 Enter 키를 누르면, 그때마다 OpenAI의 Chat API를 통해 답변이 생성된다. 이것은 대화이므로 최대 100자 정도로 입력하는 것이 좋다. 콘솔에는 AI의 발언이 표시되고, () 안에 AI의 행동이 표시된다.

사용자: 안녕하세요. 안녕하세요.
AI: 사용자님, 안녕하세요. 안녕하십니까? (답장을 보냈다.)
입력에 윤리적 또는 논리적 문제(설정과 모순되는 등)가 있어 모델이 답변을 생성할 수 없는 경우, 모델이 출력한 문자열을 오류 메시지로 콘솔에 출력한다.

행동 설명
문장 끝에 ()로 자신의 행동을 쓸 수도 있습니다.

사용자: 어이. (손을 흔들며 말을 걸다)
지시 모드
사용자: 손 들어봐 (지시)
와 같이 쓰면 봇은 스스로 생각하지 않고, 사용자의 지시에 따라 행동한다.

## 자동 모드
사용자: (자동)
와 같이 쓰면 사용자의 발언도 자동으로 생성합니다.

## 간편 모드
사용자가 6자 이내의 발언을 하면 봇은 생각하지 않고 지금까지의 대화 흐름에 따라 단순하게 응답한다. 사용 토큰이 절약되고 빠른 답변을 얻을 수 있습니다.

## 출력 파일
대화 출력
*.json: 대화 로그는 API를 호출할 때마다 대화 파일(파일명은 임의)에 추가된다. 따라서 스크립트 종료 후에도 대화를 계속 이어갈 수 있습니다. 파일은 캐릭터별로 생성할 수 있으며, 명령줄 옵션으로 캐릭터를 전환할 수 있습니다.
thought.txt: '현재 봇이 생각하고 있는 것'을 출력합니다. 이 파일은 출력할 때마다 덮어씌워집니다. 가끔 들여다보는 재미가 쏠쏠할 것이다.
prompt.txt: 실행한 프롬프트와 API 출력을 덮어쓰고 출력합니다. 참고용입니다.
요약 출력
대화(사용자 발언 → 봇 발언)가 6회 실행되거나, 현재 대화가 1000자 이상일 때 자동으로 대화 요약이 출력됩니다. 봇의 발언이 출력된 직후 연속적으로 OpenAI의 Chat API를 1회 실행하여 대화 내용과 봇의 생각으로 나누어 요약됩니다. 이 요약문은 콘솔에는 출력되지 않고 summary.txt에 덮어쓰기 출력되며, 대화 파일에도 추가된다. 요약 후, 대화 기억은 최근 3회분만 남는다. 가장 최근의 요약문은 현재 대화에서 참조됩니다. 요약은 설정에 관계없이 항상 gpt-3.5-turbo에 의해 이루어집니다.

## 종료 방법
스크립트를 종료하려면 강제 종료하십시오.

## 대화 파일(.json) 포맷
샘플을 제공하고 있으니 자세한 내용은 해당 샘플을 참고하세요.

title: 대화 제목
speaker1: 사용자의 이름
speaker2: 봇의 이름
story: 캐릭터 설정(외모, 성격, 취미, 지식 수준, 당신과의 관계, 말투, 대사 예시 등), 자신의 프로필, 스토리(세계관, 대화 상황, 장소, 시간대) 등을 자유롭게 작성해 주세요. 문장으로도, 글귀로 써도 괜찮습니다. 일본어의 경우 500~800자 정도가 적당할 것 같습니다. 토큰 절약과 사고력 향상을 기대한다면 영어로 작성하는 것이 좋습니다. speaker1},{speaker1},{speaker2},{today},{time}이라는 변수를 사용할 수 있으며, story는 현재 대화에서 매번 참조됩니다.
Tips: story는 ChatGPT가 생성하도록 하는 것이 좋습니다.
examples: 대화 예시들을 목록으로 나열합니다. examples는 현재 대화에서 매번 참조됩니다. 대화 예시는 3개 정도 있으면 좋을 것 같습니다. 각 대화는 다음과 같은 요소로 구성됩니다.
speaker1(당신)의 대사 (최대 100자 정도)
speaker1(당신)의 행동(최대 50자 정도)
speaker2(봇)의 이해(speaker1의 대사, 행동을 어떻게 이해했는지. 최대 50자 정도)
speaker2(봇)의 생각(이해를 바탕으로 무엇을 느끼고, 무엇을 하려고 했는지. 최대 50자 정도)
speaker2(봇)의 행동(생각의 결과로 어떤 행동을 했는가. 최대 50자 정도)
speaker2(봇)의 대사(생각의 결과, 최종적으로 어떤 말을 했는가. 최대 100자 정도)
oldConversations: 과거에 나눈 대화 목록
summary: 대화 요약. 최근 2개의 summary만 현재 대화에서 참조됩니다.
thought: speaker2(봇)가 해당 대화에서 생각한 내용 요약. 최근 thought만 현재 대화에서 참조된다.
conversations: 대화 내용 목록(examples와 동일한 형식). 이 대화 목록은 현재 대화에서 참조되지 않는다.
conversations: 현재 대화 목록. 현재 대화에서 참조된다. 여기에 대화 내역이 쌓여갑니다. 대화 히스토리가 6개가 쌓이면 새로운 3개만 남기고 오래된 3개는 oldConversations로 이동한다. chatgpt를 활용해서 텍스트를 입력하면 ui 코드 템플릿을 주는 예제를 코드로 설명해줘.

Translated with www.DeepL.com/Translator (free version)

# character_chat.py

## 概要

OpenAIのAPIを利用して、設定したキャラクターと日本語で会話するチャットスクリプトです。
会話文をCoT（Chain of Thought）で生成、すなわち、ボットはユーザーの発言内容を受け取り、思考してから返事を行います。

CoTを採用することで、キャラクターの一貫性を保つことを目指しました。もっと具体的にいうと、ChatGPTの「アシスタントAI」としての人格を隠蔽することが目的です。

また、キャラ設定、サンプル会話、直近の会話に加え、古い会話内容は要約した上で、コンテキストに含めます。これはChatGPTのように、AIが生成した台詞がコンテキストに蓄積されることにより、キャラ崩壊が進行する問題の解決を図るためです。
（現在のバージョンでは昔の記憶は利用していませんが、長期記憶として随時呼び出す仕組みを構想中です。）

キャラ設定、会話要約、会話内容は、キャラ（会話）毎にJSONファイルとして保存できます。会話内容はファイルに追記されていくので、会話の中断、再開が可能です。

このスクリプトは、ご自分のAPIキーを用いて、ご自分が使用することを想定しています。ご自身の責任において使用してください。

## 事前準備

1. OpenAIモジュールをインストールしてください。
	```bash
	pip install openai
	```
1. 環境変数`OPENAI_API_KEY`に、ご自分のAPIキーを記述してください。
	Windows環境なら以下のようなバッチファイルを作ると便利でしょう。
	```
	@echo off
	set OPENAI_API_KEY=あなたのAPI_KEY
	python character_chat.py conversations_sample_01.json
	```

1. 会話ファイル（JSON形式）に、下記の書式でキャラ設定を記述してください。なおこのファイルに会話ログも追記されます。サンプルをいくつか用意しているので参考にしてください。


## 実行方法

### 構文
```bash
python character_chat.py [-h] [--model model] [--rapid-mode-threshold length] [--send-url url] [--no-show-action] [--no-show-error] json_path
```

### パラメータ
- 必須パラメータ:
	- json_path
		- 会話JSONファイルパス。ファイルはスクリプトファイルと同一ディレクトリに配置するか、フルパスを指定。

- オプションパラメータ:
	- -h, --help
		- ヘルプメッセージを表示して終了する
	- --model model, -m model
		- 使用するOpenAIモデル。`gpt-3.5-turbo`もしくは`gpt-4`が指定可能（デフォルト値：`gpt-3.5-turbo`）
	- --rapid-mode-threshold length
		- 簡易モードを有効にする最大文字数。この文字数を超えると通常モード。（デフォルト値：6）
	- --send-url url
		- AIの発言を送信するURL（例：http://localhost:8080/t={speech}）
	- --no-show-action
		- AIの行動内容をコンソールに表示しない
	- --no-show-error
		- AIが台詞を生成できなかった場合でもエラーメッセージを表示しない

`--model`オプションには、`gpt-3.5-turbo`（デフォルト）か`gpt-4`のどちらかを指定してください。このスクリプトは1回のAPI呼び出しに3000トークン前後消費しますので、使用料金を鑑み、モデル選択には十分注意してください。ただし、`gpt-3.5-turbo`では十分な会話精度が得られないかもしれません。

## 使用法

### 基本
コンソールに何か発言を書き込みEnterキーを押下すると、そのたびにOpenAIのChat APIを用いて返答が生成されます。これは会話なので、入力は最大100字くらいが良いです。コンソールにはAIの発言が表示され、（）内にAIの行動が表示されます。

```
ユーザー: こんにちは。よろしくお願いします。
AI: ユーザーさん、こんにちは。お元気ですか？（返事を返した。）
```
入力に倫理的あるいは論理的な問題（設定に矛盾する等）があり、モデルが回答を生成できなかった場合は、モデルが出力した文字列を、エラーメッセージとしてコンソールに出力します。

### 行動の記述
文末に（）で自分の行動を書くこともできます。
```
ユーザー: おーい。（手を振って声を掛ける）
```

### 指示モード

```
ユーザー: 手を上げなさい（指示）
```
のように書くと、ボットは自ら思考せず、こちらの指示通りに行動します。

### 自動モード
```
ユーザー: （自動）
```
のように書くと、ユーザーの発言も自動的に生成します。

### 簡易モード

こちらの発言が6文字以内である場合、ボットは思考せず、これまでの会話の流れに沿った簡易的な応答をします。使用トークンが節約され、迅速な回答が得られます。


## 出力ファイル
### 会話出力

- `*.json`: 会話のログは、APIを呼び出すたびに、会話ファイル（ファイル名は任意）に追記されていきます。そのためスクリプト終了後も会話の続きが行えます。ファイルはキャラクター毎に作成でき、コマンドラインオプションでキャラクターを切り替えることが可能です。
- `thought.txt`: 「現在ボットが考えていること」が出力されます。このファイルは出力のたびに上書きされます。たまに覗き見すると楽しいかもしれません。
- `prompt.txt`: 実行したプロンプトとAPI出力を上書き出力します。参考用です。

### 要約出力

会話（ユーザーの発言→ボットの発言）が6回実行されるか、現在の会話が1000字を超えた際に、自動的に会話が要約されます。ボットの発言が出力された直後に連続して、OpenAIのChat APIを1回実行し、会話内容とボットの思考に分けて要約されます。この要約文はコンソールには出力されませんが、`summary.txt`に上書き出力され、会話ファイルにも追記されます。要約後、会話記憶は直近3回分だけ残されます。直近の要約文は、現在の会話で参照されます。
なお、要約は設定にかかわらず、常に`gpt-3.5-turbo`により行われます。

## 終了方法

スクリプトを終了させるには、強制終了してください。

## 会話ファイル（.json）の書式

[サンプル](./examples/)を用意しているので、詳しくはそちらを参照のこと。

- `title`: 会話のタイトル
- `speaker1`: あなたの名前
- `speaker2`: ボットの名前
- `story`: キャラクター設定（外見、性格、趣味、知識レベル、あなたとの関係性、口調、台詞例etc）、あなた自身のプロフィール、ストーリー（世界観、会話の状況、場所、時間帯）などを自由に記述してください。文章でも箇条書きでもOKです。日本語だと500～800字くらいが良さそうです。トークン節約と思考能力アップを期待するなら、英語で書くのがいいかもしれません。`{speaker1}`,`{speaker2}`,`{today}`,`{time}`という変数が使えます。`story`は現在の会話で毎回参照されます。
	- Tips: storyはChatGPTに作成させるのがお勧めです。
- `examples`: 会話例をリストで記載します。`examples`は現在の会話で毎回参照されます。会話例は3つくらいあれば良さそうです。各会話は以下の要素で構成されます。
	1. speaker1（あなた）の台詞（最大100字程度）
	1. speaker1（あなた）の行動（最大50字程度）
	1. speaker2（ボット）の理解（speaker1の台詞、行動をどう理解したか。最大50字程度）
	1. speaker2（ボット）の思考（理解に基づき、何を感じ、何をしようと思ったか。最大50字程度）
	1. speaker2（ボット）の行動（思考の結果、どういう行動をしたか。最大50字程度）
	1. speaker2（ボット）の台詞（思考の結果、最終的になんと発言したか。最大100字程度）
- `oldConversations`: 過去に行った会話リスト
	- `summary`: 会話の要約。直近2つの`summary`のみ、現在の会話で参照されます。
	- `thought`: speaker2（ボット）がその会話で思ったことの要約。直近の`thought`のみ、現在の会話で参照されます。
	- `conversations`: 会話内容のリスト（`examples`と同じフォーマット）。この会話リストは現在の会話で参照されません。
- `conversations`: 現在の会話リスト。現在の会話で参照されます。ここに会話履歴が蓄積されていきます。会話履歴が6個溜まると、新しい3個を残し、古い3個が`oldConversations`に移動します。
